{% extends '::base.html.twig' %}

{% block description %}This is an awesome web site.{% endblock %}

{% block stylesheets %}
{{parent()}}
<link href="{{ asset('jqvmap/jqvmap.css') }}" media="screen" rel="stylesheet" type="text/css" />
<style>

.node {
  cursor: pointer;
  stroke: #330099;
}

.link {
  stroke: #aaa;
  stroke-opacity: .9;
}

text {
  font: 10px sans-serif;
  pointer-events: none;
}

</style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="row">
        <div class="col-md-5">
            <h2 class="well">Evolution du nombre de brevets publiés</h2>
            <div id="charts"></div>
        </div>
        <div class="col-md-7">
            <h2 class="well">Les top 10 inventeurs du monde.</h2>
            <div id="inventorsBar"></div>
        </div>
    </div>
    <div class="row">
        <h2 class="well">Les inventeurs répartis sur les pays.</h2>
        <div class="col-md-6" id="vmap" style="height: 400px;"></div>
        <div class="col-md-6" id="countrybars"><p>Cliquez sur un pays pour voir ses top 10 inventeurs.</p></div>
    </div>
    <div class="row">
        <h2 class="well">Les mots-clé les plus fréquents dans tous les brevets.</h2>
        <canvas height="600" width="1000" id="keywordsCloud"></canvas>
        <div id="keywordsPiechart"></div>
    </div>
    <div class="row">
        <h2 class="well">Réseau de cooccurrences des auteurs</h2>
        <div id="network"></div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{parent()}}
<script src="{{ asset('highcharts/js/highcharts.js') }}"></script>
<script src="{{ asset('jqvmap/jquery.vmap.js') }}" type="text/javascript"></script>
<script src="{{ asset('jqvmap/maps/jquery.vmap.world.js') }}" type="text/javascript"></script>
<script src="{{ asset('js/vendor/wordcloud2.js') }}" type="text/javascript"></script>
<script src="{{ asset('js/vendor/d3.js') }}"></script>

<script type="text/javascript">
    $(document).ready(function() {
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_inventors')}}?n=10',
            success: function(data) {
                showInventorsBar(data, '#inventorsBar');
            }
        });
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_evolution')}}',
            success: function(data) {
                var graphData = new Array();
                var l = data.length;
                for (var i = 0; i < l; i++) {
                    graphData.push([Date.UTC(data[i].year, data[i].month - 1, data[i].day), data[i].count]);
                }
                showEvolution(graphData);
            }
        });
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_inventors_country')}}',
            success: function(data) {
                createMap(data);
            }
        });
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_keywords')}}',
            success: function(data) {
                var l = data.length;
                var d = new Array();
                for (var i = 0; i < l; i++) {
                    d.push([data[i].keyword, parseInt(data[i].count)]);
                }
                showKeywordsCloud(d);
            }
        });
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_keywords')}}?n=10',
            success: function(data) {
                var l = data.length;
                var d = new Array();
                for (var i = 0; i < l; i++) {
                    d.push([data[i].keyword, data[i].count]);
                }
                showKeywordsPieChart(d);
            }
        });
        $.ajax({
            type: 'GET',
            url: '{{path('db_main_collab_inventors')}}',
            success: function(data) {
                console.log(data.links.length);
                drawNetwork(data);
            }
        });
        
    });

    function drawNetwork ( graph ) {
        var links = graph.links;
        var nodes = {};

        links.forEach(function(link) {
          link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
          link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
        });

        var width = 1000,
            height = 1000;

        var force = d3.layout.force()
            .nodes(d3.values(nodes))
            .links(links)
            .size([width, height])
            .linkDistance(50)
            .charge(-150)
            .on("tick", tick)
            .start();

        var svg = d3.select("#network").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoom))
            .append("g");

        var link = svg.selectAll(".link")
            .data(force.links())
          .enter().append("line")
            .attr("class", "link");

        var node = svg.selectAll(".node")
            .data(force.nodes())
          .enter().append("g")
            .attr("class", "node")
            .style("stroke-width", function(d) { return (d.value)*5; })
            .on("mouseover", mouseover)
            .on("mouseout", mouseout)
            .call(force.drag);

        node.append("circle")
            .attr("r", 5);

        node.append("text")
            .attr("x", 12)
            .attr("dy", ".35em")
            .text(function(d) { return d.name; });

        function zoom() {
            svg.attr("transform", "scale(" + d3.event.scale + ")");
        }

        function tick() {
          link
              .attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });

          node
              .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        }

        function mouseover() {
          d3.select(this).select("circle").transition()
              .duration(750)
              .attr("r", 10)
              ;
        }

        function mouseout() {
          d3.select(this).select("circle").transition()
              .duration(750)
              .attr("r", 5)
              ;
        }
    }

    function inventors(element, code, region) {
        $.ajax({
            type: 'GET',
            url: '{{ path('db_main_inventors') }}?n=10&c=' + code,
            success: function(data) {
                if (data.error) {
                    alert(data.error);
                }
                showInventorsBar(data, '#countrybars');
            }
        });
    }
</script>
{% endblock %}
